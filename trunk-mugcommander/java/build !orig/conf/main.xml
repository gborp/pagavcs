<!--
This file is part of muCommander, http://www.mucommander.com
Copyright (C) 2002-2010 Maxence Bernard

muCommander is free software; you can redistribute it and/or modify
it under the terms of the GNU Lesser General Public License as published by
the Free Software Foundation, either version 3 of the License, or
(at your option) any later version.

muCommander is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
GNU Lesser General Public License for more details.

You should have received a copy of the GNU Lesser General Public License
along with this program.  If not, see <http://www.gnu.org/licenses/>.
-->

<!-- ========================================================= -->
<!-- Declares Configuration API specific properties and        -->
<!-- targets.                                                  -->
<!-- ========================================================= -->
<project>
  <!-- = Application constants =============================== -->
  <!-- ======================================================= -->
  <!-- The following properties describe the current version   -->
  <!-- of the muCommander conf API.                            -->

  <!-- Major version of the muCommander conf API.              -->
  <property name="conf.version"        value="1.0"/>
  <!-- Minor version of the muCommander conf API.              -->
  <property name="conf.subversion"     value=".0"/>
  <patternset id="conf.sources">
    <exclude name="com/mucommander/conf/impl/**"/>
    <include name="com/mucommander/conf/**"/>
    <include name="com/mucommander/xml/**"/>
  </patternset>



  <!-- = Conf API compilation ================================ -->
  <!-- ======================================================= -->
  <!-- The following tasks are used to compile the muCommander -->
  <!-- conf API.                                               -->

  <!-- Compiles the conf source code.                          -->
  <!-- Compiled sources will be stored in                      -->
  <!-- ${conf.classes.normal}.                                 -->
  <target name="conf-compile">
    <echo>Compiling Configuration API...</echo>
    <delete dir="${conf.classes.normal}"/>
    <mkdir dir="${conf.classes.normal}"/>
    <javac destdir="${conf.classes.normal}" debug="on" deprecation="on"
           encoding="utf-8" source="1.5" target="1.5" srcdir="${source}">
      <classpath>
         <fileset dir="${lib}/">
           <include name="*include/*.jar"/>
         </fileset>
      </classpath>
      <patternset refid="conf.sources"/>
    </javac>
  </target>

  <!-- Creates a JAR file containing the uncompressed,         -->
  <!-- unobfuscated conf bytecode.                             -->
  <!-- The resulting JAR file will be stored in                -->
  <!-- ${conf.jar.normal}.                                     -->
  <target name="conf-jar" depends="conf-compile">
    <echo>Creating Configuration API JAR file...</echo>
    <copy file="${conf.license}" todir="${conf.classes.normal}" overwrite="true"/>
    <jar destfile="${conf.jar.normal}" basedir="${conf.classes.normal}" excludes="**/*Test.class">
      <manifest>
        <attribute name="Specification-Title"    value="muCommander Configuration API"/>
        <attribute name="Specification-Vendor"   value="Maxence Bernard"/>
        <attribute name="Specification-Version"  value="${conf.version}"/>
        <attribute name="Implementation-Title"   value="muCommander Configuration API"/>
        <attribute name="Implementation-Vendor"  value="Maxence Bernard"/>
        <attribute name="Implementation-Version" value="${conf.version}${conf.subversion}"/>
      </manifest>
    </jar>
  </target>



  <!-- = Configuration API obfuscation ======================= -->
  <!-- ======================================================= -->
  <!-- The following targets are used to obfuscate the         -->
  <!-- muCommander conf API when possible.                     -->

  <!-- Copies the uncompressed, unobfuscated conf JAR file     -->
  <!-- over the obfuscated one.                                -->
  <!-- This target is only meant to be used when ProGuard is   -->
  <!-- not available.                                          -->
  <!-- The resulting JAR file will be stored in                -->
  <!-- ${conf.jar.obf}.                                        -->
  <target name="conf-copy-bytecode" unless="proguard.available">
    <echo>ProGuard unavailable, skipping obfuscation of the Configuration API...</echo>
    <copy file="${conf.jar.normal}" tofile="${conf.jar.obf}" overwrite="true"/>
  </target>

  <!-- Obfuscated the uncompressed, unobfuscated conf JAR      -->
  <!-- file.                                                   -->
  <!-- This target is only meant to be used when ProGuard is   -->
  <!-- available.                                              -->
  <!-- The resulting JAR file will be stored in                -->
  <!-- ${conf.jar.obf}.                                        -->
  <target name="conf-obfuscate-bytecode" depends="conf-load-libpath" if="proguard.available">
    <echo>Creating Configuration API obfuscated JAR file...</echo>
    <mkdir dir="${conf.proguard.reports}"/>
    <proguard overloadaggressively="false" usemixedcaseclassnames="${case-sensitive-fs}" ignorewarnings="true" optimize="true" shrink="true" obfuscate="true"
              printmapping="${conf.proguard.reports}/mapping.txt" printusage="${conf.proguard.reports}/usage.txt" printseeds="${conf.proguard.reports}/seeds.txt"
              allowaccessmodification="false" repackageclasses="" skipnonpubliclibraryclasses="false">
      <injar name="${conf.jar.normal}"/> 
      <outjar name="${conf.jar.obf}"/>
      <libraryjar name="${java.lib}"/>
      <libraryjar name="${lib}/noinclude" jarfilter="*.jar"/>
      <keepattribute name="exceptions"/>

      <keep access="public">
        <field access="public,protected"/>
        <method access="public,protected"/>
        <constructor access="public,protected"/>
      </keep>
    </proguard>
  </target>

  <!-- Identifies the best available obfuscation policy and    -->
  <!-- obfuscates the conf JAR file.                           -->
  <!-- The resulting JAR file will be stored in                -->
  <!-- ${conf.jar.obf}.                                        -->
  <target name="conf-obfuscate" depends="conf-jar,load-proguard,conf-copy-bytecode,conf-obfuscate-bytecode"/>



  <!-- = Conf API compression ================================ -->
  <!-- ======================================================= -->
  <!-- The following targets are used to compress the          -->
  <!-- muCommander conf API when possible.                     -->

  <!-- Compress the obfuscated conf JAR file using 7za.        -->
  <!-- This target is only meant to be called if 7za is        -->
  <!-- available.                                              -->
  <!-- The resulting JAR file will be stored in                -->
  <!-- ${conf.jar.cmp}.                                        -->
  <target name="conf-compress-obfuscated" if="7za.available">
    <echo>Compressing Configuration API...</echo>
    <delete dir="${conf.classes.obf}"/>
    <unjar src="${conf.jar.obf}" dest="${conf.classes.obf}"/>
    <exec executable="${7za.executable}" dir="${conf.classes.obf}" failonerror="true">
      <arg value="a"/>
      <arg value="-tzip"/>
      <arg value="-mm=Deflate"/>
      <arg value="-mx9"/>
      <arg value="-mfb=258"/>
      <arg value="-mpass=15"/>
      <arg value="${conf.jar.cmp}"/>
      <arg value="*"/>
    </exec>
  </target>

  <!-- Compress the obfuscated conf JAR file using standard    -->
  <!-- zip compression.                                        -->
  <!-- This target is only meant to be called if 7za is not    -->
  <!-- available.                                              -->
  <!-- The resulting JAR file will be stored in                -->
  <!-- ${conf.jar.cmp}.                                        -->
  <target name="conf-copy-obfuscated" unless="7za.available">
    <echo>7za unavailable, using standard compression for the Configuration API...</echo>
    <copy file="${conf.jar.obf}" tofile="${conf.jar.cmp}"/>
  </target>

  <!-- Identifies the best available compression policy and    -->
  <!-- compresses the conf JAR obfuscated file.                -->
  <!-- The resulting JAR file will be stored in                -->
  <!-- ${conf.jar.cmp}.                                        -->
  <target name="conf-compress" depends="check-7za,conf-obfuscate,conf-compress-obfuscated,conf-copy-obfuscated"/>



  <!-- = Reports generation ================================== -->
  <!-- ======================================================= -->
  <target name="conf-reports" depends="clean,conf-obfuscate,conf-unit-test,conf-findbugs,conf-simian,conf-javancss,conf-jdepend,conf-doccheck"/>



  <!-- = Doccheck ============================================ -->
  <!-- ======================================================= -->
  <target name="conf-do-doccheck" if="doccheck.available">
    <echo>Generating Configuration API Doccheck report...</echo>
    <mkdir dir="${conf.doccheck.reports}"/>
    <javadoc destdir="${conf.doccheck.reports}" encoding="UTF-8" access="protected" docletpath="${doccheck.lib}" doclet="com.sun.tools.doclets.doccheck.DocCheck">
      <classpath>
        <fileset dir="${lib}">
          <include name="**/*.jar"/>
        </fileset>
      </classpath>

      <!-- 'Static' sources, excluding JUnit test cases.       -->
      <packageset dir="${source}" defaultexcludes="yes">
        <include name="com/mucommander/conf"/>
        <include name="com/mucommander/xml/**"/>
      </packageset>
    </javadoc>
  </target>

  <target name="conf-skip-doccheck" unless="doccheck.available">
    <echo>Doccheck unavailable, skipping Configuration API Javadoc analysis...</echo>
  </target>

  <target name="conf-doccheck" depends="check-doccheck,conf-do-doccheck,conf-skip-doccheck"/>



  <!-- = JDepend ============================================= -->
  <!-- ======================================================= -->
  <target name="conf-do-jdepend" if="jdepend.available">
    <echo>Generating Configuration API JDepend report...</echo>
    <mkdir dir="${conf.jdepend.reports}"/>
    <jdepend outputfile="${conf.jdepend.reports}/jdepend.xml" format="xml">
      <exclude name="java.*"/>
      <exclude name="javax.*"/>
      <exclude name="junit.*"/>
      <exclude name="org.*"/>
      <classespath>
        <dirset dir="${conf.classes.normal}">
          <include name="com/mucommander/conf"/>
          <include name="com/mucommander/xml"/>
        </dirset>
      </classespath>
    </jdepend>

    <echo>Formatting Configuration API JDepend report...</echo>
    <xslt basedir="${conf.jdepend.reports}" destdir="${conf.jdepend.reports}" extension=".html" style="${ant.home}/etc/jdepend.xsl" />
  </target>

  <target name="conf-skip-jdepend" unless="jdepend.available">
    <echo>JDepend not available, skipping Configuration API dependency analysis...</echo>
  </target>

  <target name="conf-jdepend" depends="conf-compile,check-jdepend,conf-do-jdepend,conf-skip-jdepend"/>



  <!-- = Simian integration (similarity checker) ============= -->
  <!-- ======================================================= -->

  <!-- Notifies user that unit tests are being skipped if      -->
  <!-- junit is not available.                                 -->
  <target name="conf-skip-simian" unless="simian.available">
    <echo>Simian not available, skipping Configuration API similarity report...</echo>
  </target>

  <!-- Run similarity test                                     -->
  <target name="conf-do-simian" depends="load-simian" if="simian.available">
    <echo>Generating Configuration API Simian report...</echo>
    <mkdir dir="${conf.simian.reports}"/>
    <simian>
      <fileset dir="${source}">
        <patternset refid="conf.sources"/>
      </fileset>
      <formatter type="xml" toFile="${conf.simian.reports}/simian.xml"/>
    </simian>

    <echo>Formatting Configuration API Simian report...</echo>
    <xslt basedir="${conf.simian.reports}" destdir="${conf.simian.reports}" extension=".html" style="${reports-style}/simian.xsl"/>
  </target>

  <!-- Runs similarity test only if Simian is available.       -->
  <target name="conf-simian" depends="check-simian,conf-skip-simian,conf-do-simian"/>



  <!-- = Configuration unit testing ========================== -->
  <!-- ======================================================= -->

  <target name="conf-skip-unit-test" unless="junit.available">
    <echo>JUnit not available, skipping Configuration API test cases...</echo>
  </target>

  <target name="conf-do-unit-test" if="junit.available">
    <echo>Running Configuration API test cases...</echo>
    <mkdir dir="${conf.junit.reports}/raw"/>
    <mkdir dir="${conf.junit.reports}/html"/>
    <junit printsummary="yes" haltonfailure="yes">
      <formatter type="xml"/>
      <formatter type="plain"/>
      <classpath>
        <pathelement location="${conf.classes.normal}"/>
        <fileset dir="${lib}">
          <include name="**/*.jar"/>
        </fileset>
      </classpath>
      <batchtest fork="yes" todir="${conf.junit.reports}/raw">
        <fileset dir="${conf.classes.normal}">
          <include name="**/*Test.class"/>
        </fileset>
      </batchtest>
    </junit>

    <echo>Formatting Configuration API test cases...</echo>
    <junitreport todir="${conf.junit.reports}/raw">
      <fileset dir="${conf.junit.reports}/raw">
        <include name="TEST-*.xml"/>
      </fileset>
      <report format="frames" todir="${conf.junit.reports}/html"/>
    </junitreport>
  </target>

  <target name="conf-unit-test" depends="conf-jar,check-junit,conf-skip-unit-test,conf-do-unit-test"/>



  <!-- = Conf API documentation ============================== -->
  <!-- ======================================================= -->
  <!-- The following targets are used to generate the          -->
  <!-- muCommander conf API documentation.                     -->

  <!-- Generates the conf API documentation.                   -->
  <!-- Output will be stored in ${conf.doc}.                   -->
  <target name="conf-doc">
    <echo>Creating Configuration API documentation...</echo>
    <mkdir dir="${conf.doc}"/>
    <javadoc destdir="${conf.doc}" author="true" windowtitle="muCommander Configuration API" encoding="UTF-8" access="protected">
      <fileset dir="${source}/com/mucommander/conf/">
        <patternset refid="non-test-sources"/>
        <exclude name="impl/**"/>
      </fileset>
      <fileset dir="${source}/com/mucommander/xml/">
        <patternset refid="non-test-sources"/>
      </fileset>
    </javadoc>
  </target>

  <target name="conf-doc-tgz" depends="conf-doc,conf-prefixes">
    <echo>Packaging Configuration API documentation...</echo>
    <mkdir dir="${dist}"/>
    <tar destfile="${dist}/${conf.package-prefix}-docs.tar.gz" compression="gzip">
      <tarfileset dir="${conf.doc}" prefix="${conf.archive-prefix}"/>
    </tar>
  </target>


  <!-- = Findbugs integration ================================ -->
  <!-- ======================================================= -->
  <!-- Notifies user that bytecode analysis is being skipped   -->
  <!-- if FindBugs is not available.                           -->
  <target name="conf-skip-findbugs" unless="findbugs.available">
    <echo>FindBugs not available, skipping Configuration API bug report...</echo>
  </target>

  <!-- Runs FindBugs bytecode analysis and stores the output   -->
  <!-- ${tmp.compile}/findbugs.xml.                            -->
  <target name="conf-do-findbugs" depends="conf-jar" if="findbugs.available">
    <echo>Generating Configuration API FindBugs report...</echo>
    <mkdir dir="${conf.findbugs.reports}"/>
    <echo file="${conf.tmp}/findbugs-filter.xml">
&lt;FindBugsFilter&gt;
  &lt;Match&gt;
    &lt;Package name="~com\.mucommander.*" /&gt;
  &lt;/Match&gt;
&lt;/FindBugsFilter&gt;
    </echo>

    <findbugs home="${findbugs.home}" output="xml:withMessages" outputFile="${conf.findbugs.reports}/findbugs.xml" jvmargs="-Xmx128m" effort="max"
              includefilter="${conf.tmp}/findbugs-filter.xml">
      <sourcePath path="${source}" />
      <class location="${conf.jar.normal}"/>
      <auxclasspath>
        <fileset dir="${lib}/noinclude">
          <include name="**/*.jar"/>
        </fileset>
      </auxclasspath>
    </findbugs>

    <echo>Formatting Configuration API FindBugs report...</echo>
    <xslt basedir="${conf.findbugs.reports}" destdir="${conf.findbugs.reports}" extension=".html" style="${reports-style}/findbugs.xsl"/>
  </target>

  <!-- Runs FindBugs bytecode analysis if it's available.      -->
  <target name="conf-findbugs" depends="load-findbugs,conf-skip-findbugs,conf-do-findbugs"/>



  <!-- = JavaNCSS ============================================ -->
  <!-- ======================================================= -->
  <target name="conf-skip-javancss" unless="javancss.available">
    <echo>JavaNCSS not available, skipping Configuration API NCSS report...</echo>
  </target>

  <target name="conf-do-javancss" if="javancss.available">
    <echo>Generating Configuration API JavaNCSS report...</echo>
    <mkdir dir="${conf.javancss.reports}"/>
    <javancss generatereport="true" srcdir="${source}" abortOnFail="false" includes="com/mucommander/conf/*.java,com/mucommander/xml/*.java"
              outputfile="${conf.javancss.reports}/javancss.xml" format="xml"/>

    <echo>Formatting Configuration API JavaNCSS report...</echo>
    <xslt basedir="${conf.javancss.reports}" destdir="${conf.javancss.reports}" extension=".html" style="${reports-style}/javancss.xsl"/>
  </target>

  <target name="conf-javancss" depends="load-javancss,conf-skip-javancss,conf-do-javancss"/>



  <!-- = Conf API release ==================================== -->
  <!-- ======================================================= -->
  <!-- The following targets are used to generate a release    -->
  <!-- of the muCommander Configuration API.                   -->

  <!-- TODO: I'm not very happy with this target that mirrors  -->
  <!-- "load-libpath", there should be a more elegant solution -->
  <!-- to this problem.                                        -->
  <target name="normal-load-libpath" depends="load-antcontrib" unless="conf.standalone">
    <runtarget target="load-libpath"/>
  </target>

  <target name="conf-standalone-load-libpath" if="conf.standalone">
    <taskdef resource="com/mucommander/ant/antlib.xml" classpath="${tools.jar.cmp}"/>
    <libpath property="java.lib"/>
  </target>
  
  <target name="conf-load-libpath" depends="normal-load-libpath,conf-standalone-load-libpath"/>

  <!-- Stores the conf package and archive prefixes in         -->
  <!-- ${conf.package-prefix} and ${conf.archive-prefix}.      -->
  <!-- The archive prefix is meant to be used as the name of   -->
  <!-- the root directory in the conf tar.gz release file.     -->
  <!-- The package prefix is meant to be used as the name of   -->
  <!-- the tar.gz release file.                                -->
  <target name="conf-prefixes" depends="load-antcontrib">
    <echo>Creating Configuration API archive prefix...</echo>
    <propertyregex property="conf.archive-prefix" input="muCommander-conf-${conf.version}${conf.subversion}" regexp="[ .]" replace="_"/>
    <echo>Creating Configuration API package name prefix...</echo>
    <propertyregex property="conf.package-prefix" input="mucommander-conf-${conf.version}${conf.subversion}" regexp="[ .]" replace="_"/>
  </target>

  <target name="conf-release" depends="clean,conf-unit-test,conf-compress,conf-prefixes,conf-doc-tgz">
    <!-- Refreshes the release directory structure.            -->
    <delete dir="${conf.tmp}/release"/>
    <mkdir dir="${conf.tmp}/release/lib"/>
    <mkdir dir="${conf.tmp}/release/lib/noinclude"/>
    <mkdir dir="${conf.tmp}/release/docs"/>
    <mkdir dir="${conf.tmp}/release/source"/>
    <mkdir dir="${conf.tmp}/release/tools"/>

    <!-- Adds the license, readme and compile files.           -->
    <copy file="${conf.license}" todir="${conf.tmp}/release"/>
    <copy file="${conf.readme}"  todir="${conf.tmp}/release"/>
    <copy file="${conf.compile}" todir="${conf.tmp}/release"/>
    <copy todir="${conf.tmp}/release/res/reports">
      <fileset dir="${reports-style}"/>
    </copy>

    <!-- Adds the compressed JAR file.                         -->
    <copy file="${conf.jar.cmp}" todir="${conf.tmp}/release/lib"/>

    <!-- Adds the JUnit JAR file.                              -->
    <copy file="${lib}/noinclude/junit.jar" todir="${conf.tmp}/release/lib/noinclude"/>

    <!-- Adds the build files.                                 -->
    <copy file="${conf.build}" tofile="${conf.tmp}/release/build.xml"/>
    <copy todir="${conf.tmp}/release/build">
      <fileset dir="build">
        <include name="common.xml"/>
        <include name="local_template.xml"/>
        <include name="conf/structure.xml"/>
        <include name="conf/main.xml"/>
      </fileset>
    </copy>

    <!-- Adds various necessary tools.                         -->
    <copy todir="${conf.tmp}/release/tools">
      <fileset dir="${tools}/">
        <include name="proguard.jar"/>
        <include name="simian.jar"/>
        <include name="javancss.jar"/>
        <include name="jdepend.jar"/>
        <include name="doccheck.jar"/>
        <include name="ant-contrib.jar"/>
        <include name="mucommander-ant-tools.jar"/>
      </fileset>
    </copy>

    <!-- Adds the sources.                                     -->
    <copy todir="${conf.tmp}/release/source">
      <fileset dir="${source}/">
        <patternset refid="conf.sources"/>
      </fileset>
    </copy>

    <!-- Adds the documentation.                               -->
    <copy todir="${conf.tmp}/release/docs">
      <fileset dir="${conf.doc}/"/>
    </copy>

    <!-- Creates the the release file.                         -->
    <echo>Packaging Configuration API release file...</echo>
    <mkdir dir="${dist}"/>
    <tar destfile="${dist}/${conf.package-prefix}.tar.gz" compression="gzip">
      <tarfileset dir="${conf.tmp}/release/" prefix="${conf.archive-prefix}">
        <include name="**"/>
      </tarfileset>
    </tar>
  </target>
</project>
